trove = Hash.new

# ALL_CAPS variable names mean 'these are constants/these shouldn't change'.
HELLO_MESSAGE = "Here we go again!"
GOODBYE_MESSAGE = "Thanks for listening! We'll be back tomorrow morning at noon!"
TIME_TO_WAIT = 5 # Seconds to wait  before making an annoucement if a winner is found and no new prize is selected

interval = "In just under 1 hour"
lastone = false
now = Time.now

before_dying do
    puts trove.inspect
end


override = script.vars[0]

loop {
    line = get
    if line =~ /^A hidden panel beneath (.*) opens/
      trove[:latest_prize] = $1.to_s
			break
		else
			trove[:latest_prize] = nil
    end

    if line =~ /^And the winner of (.*) is... (.*)!/
      trove[:winner] = $2.to_s
      trove[:winning_time] = Time.now
      break
    else
      trove[:winner] = nil
      trove[:winning_time] = nil
    end
    
    if line =~ /^A mechanical mithril hand emerges from beneath an open panel and replenishes the empty spot along the shelf with (.*?)\./
      trove[:current_prize] = $1.to_s
      break
    else
      trove[:current_prize] = nil
    end

    if line =~ /The hand selects (.*) from an elaborately carved cabinet and sets it carefully upon a circular tray./
      trove[:new_item] = $1.to_s
    end
    
    # Normal Win Case
    if trove[:winner] && trove[:current_prize]
		  respond " "
		  respond "[TREASURE TROVE] Congratulations to the lucky Treasure Trove winner this hour for: #{trove[:latest_prize]}, it's #{trove[:winner]}! #{interval} the next item at the Treasure Trove will pull for: #{trove[:current_prize]}."
		  respond " "
		  break
    # End-of-Day Case
	  elsif trove[:winner] && !trove[:current_prize]
		  respond " "
		  respond "[TREASURE TROVE] Congratulations to the lucky Treasure Trove winner this hour for: #{trove[:latest_prize]}, it's #{trove[:winner]}! #{GOODBYE_MESSAGE}"
		  respond " "
		  break
    # Winner Unavailable Case
    elsif !trove[:winner] && trove[:current_prize]
      respond " "
      respond "[TREASURE TROVE] Congratulations to the lucky Treasure Trove winner this hour for: #{trove[:latest_prize]}, but we don't know their name because they're not logged in; they have under an hour to claim their win, though. #{interval} the next item at the Treasure Trove will pull for: #{trove[:current_prize]}."
      respond " "
      break
    # Start-of-Day Case
    elsif trove[:latest_prize]
		  respond " "
		  respond "[TREASURE TROVE] #{HELLO_MESSAGE} #{interval} the next item at the Treasure Trove will pull for: #{trove[:current_prize]}."
		  respond " "
    end
}
